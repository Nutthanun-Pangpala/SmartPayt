const db = require("../db/dbConnection");
const axios = require("axios");
require("dotenv").config();

const access_token = process.env.LINE_ACCESS_TOKEN;

exports.registerUser = async (req, res) => {
  try {
    // à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ body
    const { lineUserId, name, ID_card_No, Phone_No, Email, Home_ID, Address } = req.body;

    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸£à¸šà¸–à¹‰à¸§à¸™
    if (!ID_card_No || !Phone_No || !Email || !Home_ID || !Address) {
      return res.status(400).json({ message: "à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸šà¸–à¹‰à¸§à¸™" });
    }

    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸¢à¸²à¸§à¸‚à¸­à¸‡à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£à¸¨à¸±à¸à¸—à¹Œ
    if (Phone_No.length !== 10) {
      return res.status(400).json({ message: "à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£à¸¨à¸±à¸à¸—à¹Œà¸•à¹‰à¸­à¸‡à¸¡à¸µà¸„à¸§à¸²à¸¡à¸¢à¸²à¸§ 10 à¸«à¸¥à¸±à¸" });
    }

    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸² ID_card_No à¸«à¸£à¸·à¸­ Email à¸«à¸£à¸·à¸­ lineUserId à¸¡à¸µà¹ƒà¸™à¸£à¸°à¸šà¸šà¹à¸¥à¹‰à¸§à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
    const checkQuery = "SELECT * FROM users WHERE Home_ID = ? AND Address = ?";
    const [existingUser] = await db.promise().query(checkQuery, [Home_ID, Address]);

    if (existingUser.length > 0) {
      return res.status(400).json({ message: "à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¸™à¸µà¹‰à¸–à¸¹à¸à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¹à¸¥à¹‰à¸§" });
    }

    // à¹€à¸à¸´à¹ˆà¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹ƒà¸«à¸¡à¹ˆà¸¥à¸‡à¹ƒà¸™à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
    const insertQuery = `
      INSERT INTO users (lineUserId, name, ID_card_No, Phone_No, Email, Home_ID, Address)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `;

    const [result] = await db.promise().query(insertQuery, [
      lineUserId, name, ID_card_No, Phone_No, Email, Home_ID, Address
    ]);

    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸à¸²à¸£à¹€à¸à¸´à¹ˆà¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
    if (result.affectedRows === 0) {
      return res.status(500).json({ message: "à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸à¸´à¹ˆà¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹„à¸”à¹‰" });
    }

    // à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹à¸ˆà¹‰à¸‡à¹€à¸•à¸·à¸­à¸™à¸œà¹ˆà¸²à¸™ LINE
    try {
      await axios.post(
        "https://api.line.me/v2/bot/message/push",
        {
          to: lineUserId,
          messages: [
            {
              type: "text",
              text: `âœ… à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!\nğŸ“Œ à¸Šà¸·à¹ˆà¸­: ${name}\nğŸ“Œ Email: ${Email}\nğŸ“Œ à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£: ${Phone_No}\nğŸ  à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ: ${Address}`,
            },
          ],
        },
        {
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${access_token}`, // à¹ƒà¸Šà¹‰ token à¸‚à¸­à¸‡à¹à¸•à¹ˆà¸¥à¸° user
          },
        }
      );
    } catch (lineError) {
      console.error("âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹„à¸›à¸¢à¸±à¸‡ LINE:", lineError);
    }

    // à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸à¸¥à¸±à¸šà¹„à¸›à¹ƒà¸«à¹‰ frontend
    res.status(201).json({
      message: "à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!",
      userData: {
        lineUserId,
        name,
        ID_card_No,
        Phone_No,
        Email,
        Home_ID,
        Address,
      }
    });
  } catch (error) {
    console.error("âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”:", error);
    res.status(500).json({ message: "à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸£à¸°à¸šà¸š" });
  }
};


exports.userAddressList = async (req, res) => {
  try {
    // à¸„à¸³à¸ªà¸±à¹ˆà¸‡ SQL à¹€à¸à¸·à¹ˆà¸­à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸ˆà¸²à¸à¸•à¸²à¸£à¸²à¸‡ users
    const query = "SELECT * FROM users";
    const [users] = await db.promise().query(query);

    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
    if (users.length === 0) {
      return res.status(404).json({ message: "à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰" });
    }

    // à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸à¸¥à¸±à¸šà¹„à¸›à¸¢à¸±à¸‡ frontend
    res.status(200).json({ users });

  } catch (error) {
    console.error("âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”:", error);
    res.status(500).json({ message: "à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸£à¸°à¸šà¸š" });
  }
};

exports.reportiIssue = (req, res) => {
  const { Issues, lineUserId, name } = req.body;

  // Check for missing fields
  if (!Issues || !lineUserId || !name) {
    return res.status(400).json({ message: 'à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸šà¸–à¹‰à¸§à¸™' });
  }

  const sql = 'INSERT INTO issues (Issues, lineUserId, name) VALUES (?, ?, ?)';
  db.query(sql, [Issues, lineUserId, name], async (err, result) => {
    if (err) {
      console.error('âŒ Insert Error:', err);
      return res.status(500).json({ message: 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥' });
    }

    try {
      await axios.post(
        "https://api.line.me/v2/bot/message/push",
        {
          to: lineUserId,
          messages: [
            {
              type: "text",
              text: `âœ… à¸ªà¹ˆà¸‡à¸„à¸³à¸£à¹‰à¸­à¸‡!\nğŸ“Œ à¸Šà¸·à¹ˆà¸­: ${name}\nğŸ“Œ à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸›à¸±à¸à¸«à¸²: ${Issues}`,
            },
          ],
        },
        {
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${access_token}`, // Use your LINE bot access token
          },
        }
      );

      // Respond after sending the message
      res.json({ message: 'à¸ªà¹ˆà¸‡à¸„à¸³à¸£à¹‰à¸­à¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!' });
    } catch (lineError) {
      console.error("âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹„à¸›à¸¢à¸±à¸‡ LINE:", lineError);
      res.status(500).json({ message: 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹„à¸›à¸¢à¸±à¸‡ LINE' });
    }
  });
};

exports.userBills = (req, res) => {
  connection.query('SELECT * FROM bills', (err, results) => {
    if (err) {
      return res.status(500).send(err);
    }
    res.json(results);
  });
};